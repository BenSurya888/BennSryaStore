{% extends 'store/base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}Pembayaran - Order #{{ order.id }}{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="mb-4">
        <h1 class="h3"><i class="fas fa-receipt text-primary"></i> Konfirmasi Pesanan #{{ order.id }}</h1>
        <p class="text-muted">Selesaikan pembayaran untuk memproses pesanan Anda</p>
    </div>

    <!-- Ringkasan order -->
    <div class="card shadow-custom mb-4">
        <div class="card-header">
            <i class="fas fa-clipboard-list"></i> Ringkasan Pesanan
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="d-flex justify-content-between mb-2 pb-2 border-bottom">
                        <strong class="text-secondary">Produk:</strong>
                        <span>{{ order.product_variant.product.brand }}</span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="d-flex justify-content-between mb-2 pb-2 border-bottom">
                        <strong class="text-secondary">Kategori:</strong>
                        <span>{{ order.product_variant.category }}</span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="d-flex justify-content-between mb-2 pb-2 border-bottom">
                        <strong class="text-secondary">Paket:</strong>
                        <span class="text-end">{{ order.product_variant.name }}</span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="d-flex justify-content-between mb-2 pb-2 border-bottom">
                        <strong class="text-secondary">Tujuan:</strong>
                        <code>{{ order.target_id }}</code>
                    </div>
                </div>
                {% if order.server_id %}
                <div class="col-md-6">
                    <div class="d-flex justify-content-between mb-2 pb-2 border-bottom">
                        <strong class="text-secondary">Server ID:</strong>
                        <code>{{ order.server_id }}</code>
                    </div>
                </div>
                {% endif %}
                <div class="col-md-6">
                    <div class="d-flex justify-content-between mb-2 pb-2 border-bottom">
                        <strong class="text-secondary">Metode Bayar:</strong>
                        <span>
                            {% if order.payment_method == 'qris' %}
                            <i class="fas fa-qrcode text-primary"></i> QRIS
                            {% elif order.payment_method == 'virtual_account' %}
                            <i class="fas fa-university text-primary"></i> Virtual Account
                            {% elif order.payment_method == 'ewallet' %}
                            <i class="fas fa-wallet text-primary"></i> E-Wallet
                            {% else %}
                            {{ order.payment_method|title }}
                            {% endif %}
                        </span>
                    </div>
                </div>
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center p-3 bg-light rounded">
                        <div>
                            <strong class="text-secondary d-block mb-1">Status:</strong>
                            <span class="badge badge-{{ order.status }}">
                                {% if order.status == 'pending' %}
                                    <i class="fas fa-clock"></i> Menunggu Pembayaran
                                {% elif order.status == 'paid' %}
                                    <i class="fas fa-check"></i> Pembayaran Diterima
                                {% elif order.status == 'success' %}
                                    <i class="fas fa-check-circle"></i> Berhasil Diproses
                                {% endif %}
                            </span>
                        </div>
                        <div class="text-end">
                            <strong class="text-secondary d-block mb-1">Total Bayar:</strong>
                            <h4 class="text-primary mb-0">{{ order.amount|rupiah }}</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Instruksi pembayaran berdasarkan metode -->
    <div class="card shadow-custom mb-4">
        <div class="card-header">
            <i class="fas fa-credit-card"></i> Instruksi Pembayaran
        </div>
        <div class="card-body">
        
        {% if order.payment_method == 'qris' %}
        <div id="qris-instruction">
            <h5 class="mb-3"><i class="fas fa-qrcode text-primary"></i> Pembayaran via QRIS</h5>
            <p class="text-muted">Scan kode QR di bawah menggunakan aplikasi e-wallet atau mobile banking yang mendukung QRIS:</p>
            <div class="text-center my-4">
                <img src="{% static 'store/img/qriss.jpg' %}" alt="QRIS BennSrya" class="img-fluid rounded shadow-sm" style="max-width: 300px;">
                <div class="mt-3">
                    <a href="{% static 'store/img/qriss.jpg' %}" download="QRIS-BennSrya.png" class="btn btn-primary">
                        <i class="fas fa-download me-2"></i> Download QRIS
                    </a>
                </div>
            </div>
            <div class="alert alert-info">
                <h6 class="alert-heading"><i class="fas fa-info-circle"></i> Langkah-langkah:</h6>
                <ol class="mb-0 ps-3">
                    <li>Buka aplikasi e-wallet atau mobile banking Anda</li>
                    <li>Pilih fitur scan QRIS</li>
                    <li>Arahkan kamera ke kode QR di atas</li>
                    <li>Konfirmasi pembayaran sebesar <strong>{{ order.amount|rupiah }}</strong></li>
                    <li>Screenshot bukti pembayaran</li>
                </ol>
            </div>
        </div>

        {% elif order.payment_method == 'virtual_account' %}
        <div id="va-instruction">
            <h5 class="mb-3"><i class="fas fa-university text-primary"></i> Pembayaran via Virtual Account</h5>
            <p class="text-muted">Silakan transfer ke salah satu rekening bank berikut:</p>
            
            <div class="row g-3 mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title"><i class="fas fa-university text-primary"></i> BCA</h6>
                            <div class="d-flex justify-content-between align-items-center">
                                <code class="fs-5">1231089221</code>
                                <button class="btn btn-sm btn-outline-primary" onclick="copyToClipboard('1231089221')">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                            <small class="text-muted">a.n BennSrya</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title"><i class="fas fa-university text-primary"></i> BRI</h6>
                            <div class="d-flex justify-content-between align-items-center">
                                <code class="fs-5">0987654321</code>
                                <button class="btn btn-sm btn-outline-primary" onclick="copyToClipboard('0987654321')">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                            <small class="text-muted">a.n BennSrya</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title"><i class="fas fa-university text-primary"></i> BNI</h6>
                            <div class="d-flex justify-content-between align-items-center">
                                <code class="fs-5">1234567890</code>
                                <button class="btn btn-sm btn-outline-primary" onclick="copyToClipboard('1234567890')">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                            <small class="text-muted">a.n BennSrya</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title"><i class="fas fa-university text-primary"></i> Mandiri</h6>
                            <div class="d-flex justify-content-between align-items-center">
                                <code class="fs-5">9876543210</code>
                                <button class="btn btn-sm btn-outline-primary" onclick="copyToClipboard('9876543210')">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                            <small class="text-muted">a.n BennSrya</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="alert alert-warning">
                <h6 class="alert-heading"><i class="fas fa-exclamation-triangle"></i> Jumlah Transfer:</h6>
                <h4 class="mb-0">{{ order.amount|rupiah }}</h4>
            </div>
            
            <div class="alert alert-info">
                <h6 class="alert-heading"><i class="fas fa-info-circle"></i> Langkah-langkah:</h6>
                <ol class="mb-0 ps-3">
                    <li>Buka aplikasi mobile banking atau ATM bank Anda</li>
                    <li>Pilih menu transfer ke rekening bank</li>
                    <li>Masukkan nomor rekening di atas</li>
                    <li>Transfer sebesar <strong>{{ order.amount|rupiah }}</strong></li>
                    <li>Simpan bukti transfer</li>
                </ol>
            </div>
        </div>

        {% elif order.payment_method == 'ewallet' %}
        <div id="ewallet-instruction">
            <h5 class="mb-3"><i class="fas fa-wallet text-primary"></i> Pembayaran via E-Wallet</h5>
            <p class="text-muted">Transfer ke salah satu e-wallet berikut:</p>
            
            <div class="row g-3 mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title"><i class="fas fa-wallet text-primary"></i> DANA</h6>
                            <div class="d-flex justify-content-between align-items-center">
                                <code class="fs-5">081907444304</code>
                                <button class="btn btn-sm btn-outline-primary" onclick="copyToClipboard('081907444304')">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                            <small class="text-muted">a.n BennSrya</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title"><i class="fas fa-wallet text-primary"></i> GOPAY</h6>
                            <div class="d-flex justify-content-between align-items-center">
                                <code class="fs-5">081907444304</code>
                                <button class="btn btn-sm btn-outline-primary" onclick="copyToClipboard('081907444304')">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                            <small class="text-muted">a.n BennSrya</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title"><i class="fas fa-wallet text-primary"></i> OVO</h6>
                            <div class="d-flex justify-content-between align-items-center">
                                <code class="fs-5">081907444304</code>
                                <button class="btn btn-sm btn-outline-primary" onclick="copyToClipboard('081907444304')">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                            <small class="text-muted">a.n BennSrya</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title"><i class="fas fa-wallet text-primary"></i> LinkAja</h6>
                            <div class="d-flex justify-content-between align-items-center">
                                <code class="fs-5">081907444304</code>
                                <button class="btn btn-sm btn-outline-primary" onclick="copyToClipboard('081907444304')">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                            <small class="text-muted">a.n BennSrya</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="alert alert-info">
                <h6 class="alert-heading"><i class="fas fa-info-circle"></i> Langkah-langkah:</h6>
                <ol class="mb-0 ps-3">
                    <li>Buka aplikasi e-wallet pilihan Anda</li>
                    <li>Pilih menu transfer atau kirim uang</li>
                    <li>Masukkan nomor tujuan yang tertera di atas</li>
                    <li>Transfer sebesar <strong>{{ order.amount|rupiah }}</strong></li>
                    <li>Tambahkan keterangan: Order #{{ order.id }}</li>
                    <li>Simpan bukti transfer</li>
                </ol>
            </div>
        </div>
        {% endif %}

        <div class="alert alert-warning mt-3">
            <i class="fas fa-lightbulb"></i> Setelah transfer, upload bukti pembayaran di bawah ini. Pesanan akan diproses setelah pembayaran dikonfirmasi.
        </div>
        </div>
    </div>

    <!-- Upload bukti -->
    <div class="card shadow-custom mb-4">
        <div class="card-header">
            <i class="fas fa-upload"></i> Upload Bukti Pembayaran
        </div>
        <div class="card-body">
        
        {% if order.payment_proof %}
            <div class="alert alert-success">
                <h6 class="alert-heading"><i class="fas fa-check-circle"></i> Bukti Pembayaran Sudah Diupload</h6>
                <p class="mb-3">Silakan tunggu konfirmasi dari admin kami.</p>
            </div>
            <div class="text-center">
                <a href="{{ order.payment_proof.url }}" target="_blank">
                    <img src="{{ order.payment_proof.url }}" alt="Bukti pembayaran" class="img-fluid rounded shadow-sm" style="max-width: 400px;">
                </a>
            </div>
        {% else %}
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="mb-3">
                    <label for="proofInput" class="form-label">Pilih File Bukti Pembayaran</label>
                    <input type="file" name="proof" id="proofInput" class="form-control" accept=".jpg,.jpeg,.png,.pdf" required>
                    <div class="form-text">
                        <i class="fas fa-info-circle"></i> Format: JPG, PNG, PDF. Maksimal 5MB
                    </div>
                </div>
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-upload me-2"></i> Upload Bukti Pembayaran
                    </button>
                </div>
            </form>
        {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            // Show toast notification using Bootstrap
            const toastHTML = `
                <div class="position-fixed top-0 end-0 p-3" style="z-index: 11">
                    <div class="toast show" role="alert">
                        <div class="toast-header bg-success text-white">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong class="me-auto">Berhasil!</strong>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                        </div>
                        <div class="toast-body">
                            Nomor rekening berhasil disalin: ${text}
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', toastHTML);
            setTimeout(() => {
                document.querySelector('.toast').remove();
            }, 3000);
        }).catch(err => {
            alert('Gagal menyalin: ' + err);
        });
    }

    // Animasi untuk elemen saat di-scroll
    document.addEventListener('DOMContentLoaded', function() {
        const cards = document.querySelectorAll('.payment-card');
        
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.style.animationPlayState = 'running';
                    observer.unobserve(entry.target);
                }
            });
        }, { threshold: 0.1 });
        
        cards.forEach(card => {
            observer.observe(card);
        });
        
        // Efek untuk input file
        const fileInput = document.getElementById('proofInput');
        if (fileInput) {
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                const label = document.querySelector('.file-input-label');
                const fileText = label.querySelector('.file-text');
                
                if (file) {
                    fileText.textContent = `File dipilih: ${file.name}`;
                    label.style.background = '#e6f7ff';
                    label.style.borderColor = '#0077b6';
                    label.style.color = '#0077b6';
                }
            });
            
            // Drag and drop functionality
            const dropArea = document.querySelector('.file-input-container');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight() {
                dropArea.querySelector('.file-input-label').style.background = '#d1e7ff';
            }
            
            function unhighlight() {
                dropArea.querySelector('.file-input-label').style.background = '#f9f9f9';
            }
            
            dropArea.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                fileInput.files = files;
                
                // Trigger change event
                const event = new Event('change');
                fileInput.dispatchEvent(event);
            }
        }
    });
</script>
{% endblock %}