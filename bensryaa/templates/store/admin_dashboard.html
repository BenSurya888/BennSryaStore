{% extends 'store/base.html' %}
{% load static %}

{% block title %}Dashboard Admin - BennSrya{% endblock %}

{% block content %}
<section class="admin-dashboard container">
  <h1>📊 Dashboard Admin</h1>
  <p>Halo {{ user.username }}, selamat datang di panel admin.</p>

  <!-- Statistik ringkas -->
  <div class="stats-grid">
    <div class="stat-card"><h2>{{ total_users }}</h2><p>User Terdaftar</p></div>
    <div class="stat-card"><h2>{{ total_orders }}</h2><p>Total Order</p></div>
    <div class="stat-card"><h2>{{ pending_orders }}</h2><p>Order Pending</p></div>
    <div class="stat-card"><h2>{{ total_products }}</h2><p>Produk</p></div>
  </div>

  <!-- Aksi cepat -->
  <div class="quick-actions">
    <h2>Aksi Cepat</h2>
    <div class="action-buttons">
      <a href="{% url 'bensryaa:sync_products_from_api' %}" class="btn">🔄 Sync Produk</a>
      <a href="#" class="btn">📦 Kelola Order</a>
      <a href="#" class="btn">👥 Kelola User</a>
    </div>
  </div>

  <!-- Order terbaru -->
  <div class="latest-orders">
    <h2>📌 Order Terbaru</h2>

    <!-- TABEL DESKTOP -->
    <div class="table-wrapper">
      <table class="responsive-table">
        <thead>
          <tr>
            <th>ID</th><th>User</th><th>Produk</th><th>Status</th>
            <th>Ref ID</th><th>Status Digiflazz</th>
            <th>Tanggal</th><th>Bukti</th><th>Aksi</th>
          </tr>
        </thead>
        <tbody>
          {% for order in recent_orders %}
          <tr>
            <td>#{{ order.id }}</td>
            <td>{{ order.user.username }}</td>
            <td>{{ order.product_variant.name }}</td>
            <td>{{ order.status }}</td>
            <td>{{ order.ref_id|default:"-" }}</td>
            <td>
              {% if order.status == "success" %}✅ Sukses
              {% elif order.status == "failed" %}❌ Gagal
              {% elif order.status == "paid" %}⏳ Diproses
              {% else %}⏳ Pending{% endif %}
            </td>
            <td>{{ order.created_at|date:"d M Y H:i" }}</td>
            <td>
              {% if order.payment_proof %}
                <a href="{{ order.payment_proof.url }}" target="_blank">📷 Lihat</a>
              {% else %}Belum ada{% endif %}
            </td>
            <td>
              {% if order.status == "pending" %}
                <form method="post" action="{% url 'bensryaa:update_order_status' order.id %}">
                  {% csrf_token %}
                  <button type="submit" name="status" value="paid" class="btn">✅ Mark Paid</button>
                  <button type="submit" name="status" value="failed" class="btn">❌ Fail</button>
                </form>
              {% else %}-{% endif %}
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="9">Belum ada order.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- CARD LIST MOBILE -->
    <div class="order-card-list">
      {% for order in recent_orders %}
      <div class="order-card">
        <div class="order-row"><strong>ID:</strong> #{{ order.id }}</div>
        <div class="order-row"><strong>User:</strong> {{ order.user.username }}</div>
        <div class="order-row"><strong>Produk:</strong> {{ order.product_variant.name }}</div>
        <div class="order-row"><strong>Status:</strong> {{ order.status }}</div>
        <div class="order-row"><strong>Ref ID:</strong> {{ order.ref_id|default:"-" }}</div>
        <div class="order-row">
          <strong>Status Digiflazz:</strong>
          {% if order.status == "success" %}✅ Sukses
          {% elif order.status == "failed" %}❌ Gagal
          {% elif order.status == "paid" %}⏳ Diproses
          {% else %}⏳ Pending{% endif %}
        </div>
        <div class="order-row"><strong>Tanggal:</strong> {{ order.created_at|date:"d M Y H:i" }}</div>
        <div class="order-row">
          <strong>Bukti:</strong>
          {% if order.payment_proof %}
            <a href="{{ order.payment_proof.url }}" target="_blank">📷 Lihat</a>
          {% else %}Belum ada{% endif %}
        </div>
        <div class="order-row">
          <strong>Aksi:</strong>
          {% if order.status == "pending" %}
            <form method="post" action="{% url 'bensryaa:update_order_status' order.id %}">
              {% csrf_token %}
              <button type="submit" name="status" value="paid" class="btn small">✅ Mark Paid</button>
              <button type="submit" name="status" value="failed" class="btn small">❌ Fail</button>
            </form>
          {% else %}-{% endif %}
        </div>
      </div>
      {% empty %}
      <p>Belum ada order.</p>
      {% endfor %}
    </div>
  </div>
</section>

<style>
.table-wrapper {
  overflow-x: auto;
  border-radius: 12px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  display: block;
}
.responsive-table {
  width: 100%;
  border-collapse: collapse;
  min-width: 800px;
}
.responsive-table th,
.responsive-table td {
  padding: 10px 14px;
  font-size: 0.9rem;
  text-align: left;
  border-bottom: 1px solid #eee;
}
.responsive-table th {
  background: #f8f8f8;
  position: sticky;
  top: 0;
}
.order-card-list {
  display: none;
  margin-top: 15px;
  flex-direction: column;
  gap: 12px;
}
.order-card {
  background: white;
  border-radius: 12px;
  box-shadow: 0 3px 8px rgba(0,0,0,0.1);
  padding: 14px;
  font-size: 0.9rem;
}
.order-row {
  margin-bottom: 6px;
}
.order-row strong {
  color: #0077b6;
}
.btn.small {
  font-size: 0.8rem;
  padding: 6px 10px;
  margin-top: 4px;
}

/* Mobile: sembunyikan tabel, tampilkan card */
@media (max-width: 500px) {
  .table-wrapper { display: none; }
  .order-card-list { display: flex; }
}
</style>
{% endblock %}
