{% extends 'store/base.html' %}
{% load static %}

{% block title %}Dashboard Admin - BennSrya{% endblock %}

{% block content %}
<section class="admin-dashboard container">
  <h1>📊 Dashboard Admin</h1>
  <p>Halo {{ user.username }}, selamat datang di panel admin.</p>

  <!-- Statistik ringkas -->
  <div class="stats-grid">
    <div class="stat-card"><h2>{{ total_users }}</h2><p>User Terdaftar</p></div>
    <div class="stat-card"><h2>{{ total_orders }}</h2><p>Total Order</p></div>
    <div class="stat-card"><h2>{{ pending_orders }}</h2><p>Order Pending</p></div>
    <div class="stat-card"><h2>{{ total_products }}</h2><p>Produk</p></div>
  </div>
  <!-- Grafik ringkas -->
  <div class="chart-card">
    <h2>📈 Order 7 Hari Terakhir</h2>
    <canvas id="orderChart"
        data-labels='{{ order_chart_labels|safe }}'
        data-data='{{ order_chart_data|safe }}'></canvas>
  </div>

  <!-- Aksi cepat -->
  <div class="quick-actions">
    <h2>Aksi Cepat</h2>
    <div class="action-buttons">
      <a href="{% url 'bensryaa:sync_products_from_api' %}" class="btn" id="syncBtn">🔄 Sync Produk</a>
      <a href="#" class="btn">📦 Kelola Order</a>
      <a href="#" class="btn">👥 Kelola User</a>
    </div>
  </div>

  <!-- Order terbaru -->
  <div class="latest-orders">
    <h2>📌 Order Terbaru</h2>

    <!-- TABEL DESKTOP -->
    <div class="table-wrapper">
      <table class="responsive-table">
        <thead>
          <tr>
            <th>ID</th><th>User</th><th>Produk</th><th>Status</th>
            <th>Ref ID</th><th>Status Digiflazz</th>
            <th>Tanggal</th><th>Bukti</th><th>Aksi</th>
          </tr>
        </thead>
        <tbody>
          {% for order in recent_orders %}
          <tr>
            <td>#{{ order.id }}</td>
            <td>{{ order.user.username }}</td>
            <td>{{ order.product_variant.name }}</td>
            <td id="status-{{ order.id }}">
  <span class="status-badge status-{{ order.status }}">{{ order.status }}</span>
</td>

            <td>{{ order.ref_id|default:"-" }}</td>
            <td>
              {% if order.status == "success" %}<span class="status-badge status-success">✅ Sukses</span>
              {% elif order.status == "failed" %}<span class="status-badge status-failed">❌ Gagal</span>
              {% elif order.status == "paid" %}<span class="status-badge status-paid">⏳ Diproses</span>
              {% else %}<span class="status-badge status-pending">⏳ Pending</span>{% endif %}
            </td>
            <td>{{ order.created_at|date:"d M Y H:i" }}</td>
            <td>
              {% if order.payment_proof %}
                <a href="{{ order.payment_proof.url }}" target="_blank" class="btn small">📷 Lihat</a>
              {% else %}Belum ada{% endif %}
            </td>
            <td>
  {% if order.status == "pending" %}
    <form method="post" action="{% url 'bensryaa:update_order_status' order.id %}">
      {% csrf_token %}
      <button type="submit" name="status" value="paid" class="btn small"
              onclick="return confirm('Yakin order ini sudah dibayar?')">✅ Mark Paid</button>
      <button type="submit" name="status" value="failed" class="btn small"
              onclick="return confirm('Yakin order ini gagal?')">❌ Fail</button>
    </form>
  {% endif %}
  
  {% if order.ref_id %}
    <button type="button" class="btn small"
            onclick="cekStatus('{{ order.ref_id }}', '{{ order.id }}')">🔍 Cek Status</button>
  {% endif %}
</td>
          </tr>
          {% empty %}
          <tr><td colspan="9" style="text-align: center; padding: 20px;">Belum ada order.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- CARD LIST MOBILE -->
    <div class="order-card-list">
      {% for order in recent_orders %}
      <div class="order-card">
        <div class="order-row"><strong>ID:</strong> #{{ order.id }}</div>
        <div class="order-row"><strong>User:</strong> {{ order.user.username }}</div>
        <div class="order-row"><strong>Produk:</strong> {{ order.product_variant.name }}</div>
        <div class="order-row"><strong>Status:</strong> 
  <span id="status-{{ order.id }}" class="status-badge status-{{ order.status }}">{{ order.status }}</span>
</div>

        <div class="order-row"><strong>Ref ID:</strong> {{ order.ref_id|default:"-" }}</div>
        <div class="order-row">
          <strong>Status Digiflazz:</strong>
          {% if order.status == "success" %}<span class="status-badge status-success">✅ Sukses</span>
          {% elif order.status == "failed" %}<span class="status-badge status-failed">❌ Gagal</span>
          {% elif order.status == "paid" %}<span class="status-badge status-paid">⏳ Diproses</span>
          {% else %}<span class="status-badge status-pending">⏳ Pending</span>{% endif %}
        </div>
        <div class="order-row"><strong>Tanggal:</strong> {{ order.created_at|date:"d M Y H:i" }}</div>
        <div class="order-row">
          <strong>Bukti:</strong>
          {% if order.payment_proof %}
            <a href="{{ order.payment_proof.url }}" target="_blank" class="btn small">📷 Lihat</a>
          {% else %}Belum ada{% endif %}
        </div>
        <div class="order-row">
          <strong>Aksi:</strong>
          {% if order.ref_id %}
  <button type="button" class="btn small"
          onclick="cekStatus('{{ order.ref_id }}', '{{ order.id }}')">🔍 Cek Status</button>
{% endif %}

          {% if order.status == "pending" %}
            <form method="post" action="{% url 'bensryaa:update_order_status' order.id %}">
              {% csrf_token %}
              <button type="submit" name="status" value="paid" class="btn small"
                      onclick="return confirm('Yakin order ini sudah dibayar?')">✅ Mark Paid</button>
              <button type="submit" name="status" value="failed" class="btn small"
                      onclick="return confirm('Yakin order ini gagal?')">❌ Fail</button>
            </form>
          {% else %}-{% endif %}
        </div>
      </div>
      {% empty %}
      <div class="order-card" style="text-align: center;">
        <p>Belum ada order.</p>
      </div>
      {% endfor %}
    </div>
  </div>
</section>

<!-- Chart.js -->

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
 <script>
  window.orderChartLabels = {{ order_chart_labels|safe }};
  window.orderChartData = {{ order_chart_data|safe }};
</script>
<script src="{% static 'store/js/admin_dashboard.js' %}"></script>
{% endblock %}
