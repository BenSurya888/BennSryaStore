{% extends 'store/base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}{{ object.brand }} - BennSrya Store{% endblock %}

{% block content %}
<section class="product-detail container">

  <!-- Breadcrumb -->
  <nav class="breadcrumb">
    <a href="{% url 'bensryaa:index' %}">Home</a> â€º
    <span>{{ object.brand }}</span>
  </nav>

  <!-- Header produk -->
  <div class="product-header">
    <img src="{% static object.image_url %}" alt="{{ object.brand }}">
    <div class="info">
      <h1>{{ object.brand }}</h1>
      <p>{{ object.brand }} Top Up, proses cepat & otomatis.</p>
    </div>
  </div>

  <!-- Form order -->
  <form method="post" action="{% url 'bensryaa:create_order' %}" id="orderForm">
  {% csrf_token %}
    <!-- Input user -->
    <div class="user-input">
      {% if default_category == "pulsa" or default_category == "data" %}
        <input type="text" id="userInput" name="target_id" placeholder="Nomor HP" required>
      {% elif default_category == "pln" %}
        <input type="text" id="userInput" name="target_id" placeholder="ID Pelanggan PLN" required>
      {% elif default_category == "game" %}
        <input type="text" id="userInput" name="target_id" placeholder="User ID" required>
        <input type="text" name="server_id" placeholder="Server ID (opsional)">
      {% else %}
        <input type="text" id="userInput" name="target_id" placeholder="ID / Nomor" required>
      {% endif %}
    </div>

    <!-- Tab kategori -->
    <div class="variant-tabs">
      {% for category, items in grouped_variants.items %}
        <button type="button" 
                class="tab-btn {% if forloop.first %}active{% endif %}" 
                data-category="{{ category }}">
          {{ category }}
        </button>
      {% endfor %}
    </div>

    <!-- Daftar varian -->
    {% for category, items in grouped_variants.items %}
      <div class="variant-list {% if forloop.first %}active{% endif %}" data-category="{{ category }}">
        <ul>
          {% for variant in items %}
            <li class="variant-item" data-code="{{ variant.code }}">
              <span class="v-name">{{ variant.name }}</span>
              <span class="v-price">{{ variant.price|rupiah }}</span>
            </li>
          {% endfor %}
        </ul>
      </div>
    {% endfor %}

    <!-- Hidden input buat varian terpilih -->
    <input type="hidden" name="variant_code" id="variantCode">

    <!-- Tombol beli -->
    <div class="form-actions">
      <button type="submit" id="buyBtn" class="buy-submit" style="display:none;">
        ðŸ›’ Beli Sekarang
      </button>
    </div>
  </form>
</section>

<!-- Script JS -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const tabs = document.querySelectorAll(".tab-btn");
    const lists = document.querySelectorAll(".variant-list");
    const buyBtn = document.getElementById("buyBtn");
    const variantCode = document.getElementById("variantCode");
    const form = document.getElementById("orderForm");
    const userInput = document.getElementById("userInput");

    // Tab handler
    tabs.forEach(tab => {
      tab.addEventListener("click", () => {
        tabs.forEach(t => t.classList.remove("active"));
        lists.forEach(l => l.classList.remove("active"));
        tab.classList.add("active");
        const category = tab.dataset.category;
        document.querySelector(`.variant-list[data-category="${category}"]`).classList.add("active");
      });
    });

    // Pilih varian
    document.querySelectorAll(".variant-item").forEach(item => {
      item.addEventListener("click", () => {
        document.querySelectorAll(".variant-item").forEach(i => i.classList.remove("selected"));
        item.classList.add("selected");
        variantCode.value = item.dataset.code;
        buyBtn.style.display = "block";
      });
    });

    // Validasi submit
    form.addEventListener("submit", (e) => {
      if (!userInput.value) {
        e.preventDefault();
        alert("Harap masukkan ID / Nomor dulu.");
        return;
      }
      if (!variantCode.value) {
        e.preventDefault();
        alert("Silakan pilih paket dulu.");
        return;
      }
    });
  });
</script>
{% endblock %}
