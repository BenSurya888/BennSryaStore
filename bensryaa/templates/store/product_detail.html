{% extends 'store/base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}{{ object.brand }} - BennSrya Store{% endblock %}

{% block content %}
<section class="product-detail container">
    <!-- Breadcrumb -->
    <nav class="breadcrumb">
        <a href="{% url 'bensryaa:index' %}">üè† Home</a>
        <span>{{ object.brand }}</span>
    </nav>

    <!-- Product Header -->
    <div class="product-header">
        <img src="{{ brand_logo }}" alt="{{ object.brand }}" class="product-logo">
        <div class="info">
            <h1>{{ object.brand }}</h1>
            <p>{{ object.brand }} Top Up, proses cepat & otomatis 24/7.</p>
        </div>
    </div>

    <!-- Form order -->
    <form method="post" action="{% url 'bensryaa:create_order' %}" id="orderForm">
        {% csrf_token %}
        
        <!-- User Input Fields -->
        <div class="user-input">
            {% for field in input_fields %}
            <div class="input-group">
                <label for="{{ field.name }}" class="input-label">
                    {{ field.label }}
                    {% if field.required %}<span class="required">*</span>{% endif %}
                </label>
                <input
                    type="{{ field.type }}"
                    name="{{ field.name }}"
                    id="{{ field.name }}"
                    placeholder="{{ field.placeholder }}"
                    {% if field.required %}required{% endif %}
                    {% if field.pattern %}pattern="{{ field.pattern }}"{% endif %}
                    {% if field.title %}title="{{ field.title }}"{% endif %}
                    class="form-input"
                >
                {% if field.help_text %}
                <small class="help-text">{{ field.help_text }}</small>
                {% endif %}
            </div>
            {% endfor %}
        </div>

        <!-- Tab kategori -->
        <div class="variant-tabs">
            {% for category, items in grouped_variants.items %}
                <button type="button" 
                        class="tab-btn {% if forloop.first %}active{% endif %}" 
                        data-category="{{ category }}">
                    {{ category|title }}
                </button>
            {% endfor %}
        </div>

        <!-- Daftar varian -->
        {% for category, items in grouped_variants.items %}
            <div class="variant-list {% if forloop.first %}active{% endif %}" data-category="{{ category }}">
                <div class="variant-grid">
                    {% for variant in items %}
                        <div class="variant-item" data-code="{{ variant.code }}" data-price="{{ variant.price }}" data-name="{{ variant.name }}">
                            <div class="variant-content">
                                <span class="v-name">{{ variant.name }}</span>
                                <span class="v-price">{{ variant.price|rupiah }}</span>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endfor %}

        <!-- Opsi Pembayaran -->
        <div class="payment-methods">
            <h3>üí≥ Metode Pembayaran</h3>
            <div class="payment-options">
                <label class="payment-option">
                    <input type="radio" name="payment_method" value="qris" checked>
                    <div class="payment-card">
                        <div class="payment-icon">üì±</div>
                        <div class="payment-info">
                            <h4>QRIS</h4>
                            <p>Bayar dengan QRIS via e-wallet</p>
                            <small>Proses instan, semua e-wallet</small>
                        </div>
                    </div>
                </label>

                <label class="payment-option">
                    <input type="radio" name="payment_method" value="virtual_account">
                    <div class="payment-card">
                        <div class="payment-icon">üè¶</div>
                        <div class="payment-info">
                            <h4>Virtual Account</h4>
                            <p>Transfer via BCA, BRI, BNI, Mandiri</p>
                            <small>Transfer bank tanpa admin</small>
                        </div>
                    </div>
                </label>

                <label class="payment-option">
                    <input type="radio" name="payment_method" value="ewallet">
                    <div class="payment-card">
                        <div class="payment-icon">üíé</div>
                        <div class="payment-info">
                            <h4>E-Wallet</h4>
                            <p>Bayar dengan DANA, OVO, GoPay</p>
                            <small>Mudah dan cepat</small>
                        </div>
                    </div>
                </label>



        <!-- Hidden input for selected variant code -->
        <input type="hidden" name="variant_code" id="variantCode">

        <!-- Order Summary (shown when variant selected) -->
        <div class="order-summary-row-wrapper">
            <div class="order-summary hidden" id="orderSummary">
                <div class="summary-row"><strong>Produk:</strong> <span id="summaryProduct">-</span></div>
                <div class="summary-row"><strong>Paket:</strong> <span id="summaryPackage">-</span></div>
                <div class="summary-row"><strong>Tujuan:</strong> <span id="summaryTarget">-</span></div>
                <div class="summary-row"><strong>Metode Bayar:</strong> <span id="summaryPayment">-</span></div>
                <div class="summary-row total"><strong>Total:</strong> <span id="summaryTotal">-</span></div>
            </div>
            <div class="buy-btn-wrapper">
                <button type="button" class="buy-btn" id="buyBtn" disabled>
                    <span>üõí</span> Beli Sekarang
                </button>
            </div>
        </div>

        <!-- Modal for order review -->
        <div class="custom-modal neumorphic-modal" id="customModal" style="display: none;">
            <div class="modal-dialog">
                <div class="modal-header neumorphic-modal-header">
                    <span class="neumorphic-modal-title">Review Pesanan</span>
                    <button type="button" class="modal-close neumorphic-modal-close" aria-label="Tutup">&times;</button>
                </div>
                <div class="modal-body neumorphic-modal-body" id="modalContent">
                    <!-- Modal content will be injected by JS -->
                </div>
                <div class="modal-footer neumorphic-modal-footer">
                    <button type="button" class="modal-cancel neumorphic-btn-cancel">Batal</button>
                    <button type="button" class="modal-confirm neumorphic-btn-confirm">Konfirmasi & Bayar</button>
                </div>
            </div>
        </div>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const tabs = document.querySelectorAll(".tab-btn");
        const lists = document.querySelectorAll(".variant-list");
        const buyBtn = document.getElementById("buyBtn");
        const variantCode = document.getElementById("variantCode");
        const form = document.getElementById("orderForm");
        const modal = document.getElementById("customModal");
        const modalContent = document.getElementById("modalContent");
        const modalConfirm = document.querySelector(".modal-confirm");
        const modalCancel = document.querySelector(".modal-cancel");
        const modalClose = document.querySelector(".modal-close");
        const orderSummary = document.getElementById("orderSummary");
        const userInputs = document.querySelectorAll('.user-input input');
        const paymentOptions = document.querySelectorAll('input[name="payment_method"]');
        let lastFocusedElement = null;

        // Tab handler
        tabs.forEach(tab => {
            tab.addEventListener("click", () => {
                tabs.forEach(t => t.classList.remove("active"));
                lists.forEach(l => l.classList.remove("active"));
                tab.classList.add("active");
                const category = tab.dataset.category;
                document.querySelector(`.variant-list[data-category="${category}"]`).classList.add("active");
            });
        });

        // Pilih varian
        document.querySelectorAll(".variant-item").forEach(item => {
            item.addEventListener("click", () => {
                document.querySelectorAll(".variant-item").forEach(i => i.classList.remove("selected"));
                item.classList.add("selected");
                variantCode.value = item.dataset.code;
                buyBtn.disabled = false;
                buyBtn.innerHTML = '<span>üõí</span> Beli Sekarang - ' + item.querySelector('.v-price').textContent;
                orderSummary.classList.remove('hidden');
                updateOrderSummary();
                buyBtn.style.animation = "pulse 0.5s ease";
                setTimeout(() => { buyBtn.style.animation = ""; }, 500);
            });
        });

        paymentOptions.forEach(option => {
            option.addEventListener('change', function() {
                updateOrderSummary();
            });
        });

        function updateOrderSummary() {
            const selectedVariant = document.querySelector('.variant-item.selected');
            const selectedPayment = document.querySelector('input[name="payment_method"]:checked');
            const targetInput = document.querySelector('input[name="target_id"]');
            if (selectedVariant) {
                document.getElementById('summaryProduct').textContent = '{{ object.brand }}';
                document.getElementById('summaryPackage').textContent = selectedVariant.querySelector('.v-name').textContent;
                document.getElementById('summaryTotal').textContent = selectedVariant.querySelector('.v-price').textContent;
                document.getElementById('summaryTarget').textContent = (targetInput && targetInput.value) ? targetInput.value : '-';
                if (selectedPayment) {
                    const paymentText = selectedPayment.parentElement.querySelector('h4').textContent;
                    document.getElementById('summaryPayment').textContent = paymentText;
                }
            }
        }

        userInputs.forEach(input => {
            input.addEventListener('input', () => {
                input.classList.remove('error');
                if (input.name === 'target_id') updateOrderSummary();
            });
        });

        function showModal(message) {
            lastFocusedElement = document.activeElement;
            modalContent.innerHTML = message;
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            // Focus trap: focus first button in modal
            setTimeout(() => {
                const focusable = modal.querySelectorAll('button, [tabindex]:not([tabindex="-1"])');
                if (focusable.length) focusable[0].focus();
            }, 50);
        }

        function hideModal() {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
            if (lastFocusedElement) lastFocusedElement.focus();
        }

        // Modal event listeners
        modalConfirm.addEventListener('click', function() { form.submit(); });
        modalCancel.addEventListener('click', hideModal);
        modalClose.addEventListener('click', hideModal);
        modal.addEventListener('click', function(e) { if (e.target === modal) hideModal(); });
        document.addEventListener('keydown', function(e) {
            if (modal.style.display === 'flex') {
                if (e.key === 'Escape') hideModal();
                // Trap focus inside modal
                if (e.key === 'Tab') {
                    const focusable = modal.querySelectorAll('button, [tabindex]:not([tabindex="-1"])');
                    if (!focusable.length) return;
                    const first = focusable[0];
                    const last = focusable[focusable.length - 1];
                    if (e.shiftKey) {
                        if (document.activeElement === first) { e.preventDefault(); last.focus(); }
                    } else {
                        if (document.activeElement === last) { e.preventDefault(); first.focus(); }
                    }
                }
            }
        });

        buyBtn.addEventListener("click", (e) => {
            e.preventDefault();
            let hasEmptyField = false;
            let emptyFields = [];
            userInputs.forEach(input => {
                if (input.hasAttribute('required') && !input.value.trim()) {
                    hasEmptyField = true;
                    emptyFields.push(input.placeholder || input.name);
                    input.classList.add('error');
                    input.focus();
                }
            });
            if (hasEmptyField) {
                showModal(`
                    <div class="modal-error">
                        <h4>‚ùå Data Belum Lengkap</h4>
                        <p>Harap isi semua field yang wajib diisi:</p>
                        <ul>
                            ${emptyFields.map(field => `<li>${field}</li>`).join('')}
                        </ul>
                    </div>
                `);
                return;
            }
            if (!variantCode.value) {
                showModal(`
                    <div class="modal-error">
                        <h4>‚ùå Paket Belum Dipilih</h4>
                        <p>Silakan pilih paket terlebih dahulu sebelum melanjutkan.</p>
                    </div>
                `);
                return;
            }
            const selectedVariant = document.querySelector('.variant-item.selected');
            const selectedPayment = document.querySelector('input[name="payment_method"]:checked');
            const paymentText = selectedPayment.parentElement.querySelector('h4').textContent;
            let confirmMsg = `
                <div class="modal-success">
                    <h4>‚úÖ Konfirmasi Pesanan</h4>
                    <p>Pastikan data berikut sudah benar:</p>
                    <div class="confirmation-details">
            `;
            userInputs.forEach(input => {
                const label = input.placeholder || input.name;
                confirmMsg += `
                    <div class="detail-row">
                        <strong>${label}:</strong>
                        <span>${input.value}</span>
                    </div>
                `;
            });
            confirmMsg += `
                        <div class="detail-row">
                            <strong>Produk:</strong>
                            <span>{{ object.brand }}</span>
                        </div>
                        <div class="detail-row">
                            <strong>Paket:</strong>
                            <span>${selectedVariant.querySelector('.v-name').textContent}</span>
                        </div>
                        <div class="detail-row">
                            <strong>Metode Bayar:</strong>
                            <span>${paymentText}</span>
                        </div>
                        <div class="detail-row total">
                            <strong>Total Bayar:</strong>
                            <span>${selectedVariant.querySelector('.v-price').textContent}</span>
                        </div>
                    </div>
                    <p class="note">Klik \"Konfirmasi & Bayar\" untuk melanjutkan ke halaman pembayaran.</p>
                </div>
            `;
            showModal(confirmMsg);
        });
    });
</script>
{% endblock %}